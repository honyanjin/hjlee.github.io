import{j as e,X as U,R as A,i as G,K as F,x as T,N as O}from"./ui-XXTzK_eR.js";import{r as s}from"./router-CLvrYEWH.js";import{s as R}from"./index-BOAHjvuv.js";import{l as H,i as M,g as W}from"./storage-pECbbs46.js";const P=50,q=({isOpen:d,onClose:h,onSelect:b,bucket:c})=>{const[x,n]=s.useState([]),[k,g]=s.useState(0),[j,o]=s.useState(!1),[u,D]=s.useState(!1),[B,v]=s.useState(""),[w,C]=s.useState(""),[p,I]=s.useState(""),[m,S]=s.useState("created"),[y,r]=s.useState("desc");s.useEffect(()=>{d&&(n([]),g(0),o(!1),v(""),i(!0))},[d,c,p]);const i=async(t=!1)=>{try{D(!0),v("");const l=t?0:k,f=await H(c,{prefix:p,limit:P,offset:l*P,sortBy:{column:"name",order:"desc"}});n(L=>t?f:[...L,...f]),o((f?.length||0)===P),g(t?1:l+1)}catch(l){v(l.message||"이미지 목록을 불러오지 못했습니다.")}finally{D(!1)}},E=s.useMemo(()=>Array.from(new Set(x.filter(t=>t?.metadata==null).map(t=>t.name.replace(/\/$/,"")))).sort((t,l)=>t.localeCompare(l)),[x]),z=s.useMemo(()=>{let t=x.filter(a=>{const N=a.metadata?.size,K=(a.name.split("/").pop()||a.name).toLowerCase().startsWith(".");return N!=null&&N>0&&!K&&M(a.name)});const l=w.trim().toLowerCase();l&&(t=t.filter(a=>a.name.toLowerCase().includes(l)));const f=y==="asc"?1:-1,L=a=>a.metadata?.size??-1,$=a=>a.created_at?new Date(a.created_at).getTime():0;return t=[...t].sort((a,N)=>m==="name"?a.name.localeCompare(N.name)*f:m==="size"?(L(a)-L(N))*f:($(a)-$(N))*f),t},[x,w,m,y]);return d?e.jsxs("div",{className:"fixed inset-0 z-[100000]",children:[" ",e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:h}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-5xl bg-white dark:bg-gray-800 rounded-lg shadow-xl overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-gray-200 dark:border-gray-700",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-white",children:["라이브러리에서 선택 (",c,")"]})}),e.jsx("button",{onClick:h,className:"p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700",children:e.jsx(U,{size:18})})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{value:p,onChange:t=>I(t.target.value),className:"px-3 py-2 rounded-md border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white w-56","aria-label":"폴더 선택",children:[e.jsx("option",{value:"",children:"/ (루트)"}),p&&e.jsx("option",{value:p,children:`${p.replace(/\/+$/,"")}/ (현재)`}),E.map(t=>e.jsxs("option",{value:t+"/",children:[t,"/"]},t))]}),e.jsxs("button",{type:"button",onClick:()=>i(!0),className:"inline-flex items-center gap-1 px-3 py-2 rounded-md border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700",children:[e.jsx(A,{size:16})," 새로고침"]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(G,{size:16,className:"absolute left-2 top-1/2 -translate-y-1/2 text-gray-400"}),e.jsx("input",{value:w,onChange:t=>C(t.target.value),placeholder:"파일명 검색",className:"pl-8 pr-3 py-2 rounded-md border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white w-64"})]})]}),e.jsx("div",{className:"min-h-[240px]",children:u&&x.length===0?e.jsx("div",{className:"flex items-center justify-center py-12 text-gray-500 dark:text-gray-400",children:"불러오는 중..."}):z.length===0?e.jsx("div",{className:"text-center py-12 text-gray-500 dark:text-gray-400",children:"파일이 없습니다."}):e.jsx("div",{className:"overflow-auto rounded-md border border-gray-200 dark:border-gray-700",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700 table-fixed",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-800",children:e.jsxs("tr",{children:[e.jsx("th",{className:"w-28 px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300",children:"미리보기"}),e.jsxs("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 cursor-pointer select-none",onClick:()=>{S("name"),r(t=>t==="asc"?"desc":"asc")},children:["파일명 ",m==="name"?y==="asc"?"▲":"▼":""]}),e.jsxs("th",{className:"w-24 px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 cursor-pointer select-none",onClick:()=>{S("size"),r(t=>t==="asc"?"desc":"asc")},children:["크기 ",m==="size"?y==="asc"?"▲":"▼":""]}),e.jsxs("th",{className:"w-40 px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 cursor-pointer select-none",onClick:()=>{S("created"),r(t=>t==="asc"?"desc":"asc")},children:["업로드일자 ",m==="created"?y==="asc"?"▲":"▼":""]}),e.jsx("th",{className:"w-28 px-3 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-300",children:"선택"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700 bg-white dark:bg-gray-900",children:z.map(t=>{const l=t.publicUrl||W(c,t.name);return e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2",children:M(t.name)?e.jsx("img",{src:l,alt:t.name,className:"w-20 h-20 object-cover rounded",loading:"lazy"}):e.jsx("div",{className:"w-20 h-20 rounded bg-gray-100 dark:bg-gray-800"})}),e.jsx("td",{className:"px-3 py-2",children:e.jsx("div",{className:"text-sm text-gray-900 dark:text-gray-100 break-all",children:t.name})}),e.jsx("td",{className:"px-3 py-2 text-sm text-gray-700 dark:text-gray-300",children:(t.metadata?.size??0)>0?`${(t.metadata.size/1024).toFixed(1)} KB`:"—"}),e.jsx("td",{className:"px-3 py-2 text-sm text-gray-700 dark:text-gray-300",children:t.created_at?new Date(t.created_at).toLocaleString():"—"}),e.jsx("td",{className:"px-3 py-2",children:e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{type:"button",className:"px-3 py-1 text-xs rounded bg-teal-600 hover:bg-indigo-900 text-white",onClick:()=>b(l),children:"선택"})})})]},t.name)})})]})})}),j&&e.jsx("div",{className:"flex justify-center pt-2",children:e.jsx("button",{type:"button",disabled:u,onClick:()=>i(!1),className:"px-4 py-2 text-sm rounded-md border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50",children:u?"불러오는 중...":"더 보기"})})]})]})})]}):null},_=s.createContext(void 0),ee=({children:d})=>{const[h,b]=s.useState(!1),[c,x]=s.useState("blog-images"),n=s.useRef(null),k=s.useCallback(({bucket:o})=>(x(o),b(!0),new Promise(u=>{n.current=u})),[]),g=()=>{n.current&&n.current(null),n.current=null,b(!1)},j=o=>{n.current&&n.current(o),n.current=null,b(!1)};return e.jsxs(_.Provider,{value:{open:k},children:[d,e.jsx("div",{id:"image-library-portal",className:"fixed inset-0 pointer-events-none z-[100000]",children:e.jsx("div",{className:"pointer-events-auto",children:e.jsx(q,{isOpen:h,onClose:g,onSelect:j,bucket:c})})})]})},J=()=>{const d=s.useContext(_);if(!d)throw new Error("useImageLibrary must be used within ImageLibraryProvider");return d},te=({onImageUpload:d,currentImage:h,className:b="",bucketName:c="blog-images"})=>{const[x,n]=s.useState(!1),[k,g]=s.useState(!1),[j,o]=s.useState(""),u=s.useRef(null),[D,B]=s.useState(!1),v=async r=>{if(r){if(r.size>5*1024*1024){o("파일 크기는 5MB 이하여야 합니다.");return}if(!r.type.startsWith("image/")){o("이미지 파일만 업로드 가능합니다.");return}try{n(!0),o("");const i=(r.name.split(".").pop()||"png").toLowerCase(),z=`${(r.name.split(".").slice(0,-1).join(".")||"image").normalize("NFKC").toLowerCase().replace(/[^a-z0-9._-]/g,"-").replace(/-+/g,"-").replace(/^-+|-+$/g,"").slice(0,60)||"image"}-${Date.now().toString(36)}.${i}`,{error:t}=await R.storage.from(c).upload(z,r,{cacheControl:"3600",upsert:!1});if(t)throw t;const{data:l}=R.storage.from(c).getPublicUrl(z);d(l.publicUrl)}catch(i){o(i.message||"이미지 업로드에 실패했습니다.")}finally{n(!1)}}},w=r=>{const i=r.target.files?.[0];i&&v(i)},C=r=>{r.preventDefault(),r.stopPropagation(),r.type==="dragenter"||r.type==="dragover"?g(!0):r.type==="dragleave"&&g(!1)},p=r=>{r.preventDefault(),r.stopPropagation(),g(!1);const i=r.dataTransfer.files?.[0];i&&v(i)},I=()=>{d("")},m=()=>c==="project-images"?"💡 권장: 1200×630px (19:10 비율) - 프로젝트 썸네일용":"💡 권장: 896×384px (7:3 비율) - 블로그 헤더용",{open:S}=J(),y=async()=>{const r=await S({bucket:c});r&&d(r)};return e.jsxs("div",{className:`space-y-4 ${b}`,children:[j&&e.jsx("div",{className:"bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-600 dark:text-red-400 px-4 py-3 rounded-md",children:j}),h?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:h,alt:"업로드된 이미지",className:"w-full h-64 sm:h-80 lg:h-96 object-cover rounded-lg"}),e.jsx("button",{type:"button",onClick:I,className:"absolute top-2 right-2 bg-red-600 text-white p-1 rounded-full hover:bg-red-700 transition-colors",children:e.jsx(U,{size:16})}),e.jsxs("button",{type:"button",onClick:y,className:"absolute top-2 left-2 bg-white/90 dark:bg-gray-800/90 text-gray-800 dark:text-gray-200 px-2 py-1 rounded-md shadow hover:bg-white dark:hover:bg-gray-700 transition-colors flex items-center gap-1",children:[e.jsx(F,{size:14}),"라이브러리에서 선택"]})]}),e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-xs text-blue-600 dark:text-blue-400 font-medium",children:m()})})]}):e.jsxs("div",{className:`border-2 border-dashed rounded-lg p-6 text-center transition-colors ${k?"border-blue-500 bg-blue-50 dark:bg-blue-900/20":"border-gray-300 dark:border-gray-600 hover:border-gray-400 dark:hover:border-gray-500"}`,onDragEnter:C,onDragLeave:C,onDragOver:C,onDrop:p,children:[e.jsx("input",{ref:u,type:"file",accept:"image/*",onChange:w,className:"hidden"}),x?e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx(T,{className:"h-8 w-8 text-blue-600 animate-spin"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"이미지 업로드 중..."})]}):e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx("div",{className:"p-3 bg-blue-100 dark:bg-blue-900 rounded-full",children:e.jsx(O,{className:"h-6 w-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"이미지를 드래그하여 업로드하거나"}),e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx("button",{type:"button",onClick:()=>u.current?.click(),className:"text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 font-medium",children:"파일 선택"}),e.jsx("span",{className:"text-gray-400",children:"/"}),e.jsxs("button",{type:"button",onClick:y,className:"text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 font-medium flex items-center gap-1",children:[e.jsx(F,{size:16})," 라이브러리에서 선택"]})]})]}),e.jsxs("div",{className:"text-center space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"PNG, JPG, GIF 최대 5MB"}),e.jsx("p",{className:"text-xs text-blue-600 dark:text-blue-400 font-medium",children:m()})]})]})]})]})};export{ee as I,te as a,J as u};
