import{j as e}from"./ui-DZss5j7o.js";import{r as s}from"./router-CLvrYEWH.js";import{u as J,o as K,f as W,c as X,a as Z,b as ee,I as te,s as i}from"./index-D65f1dRP.js";import{R as re}from"./RichTextEditor-CTpYoa8s.js";import"./vendor-RGnvvjkK.js";const ne=()=>{const[y,M]=s.useState([]),[D,f]=s.useState(!0),[j,d]=s.useState(""),[R,o]=s.useState(!1),[c,k]=s.useState(null),[l,x]=s.useState(""),[w,N]=s.useState(""),[v,p]=s.useState(""),[_,A]=s.useState(!1),[n,T]=s.useState(""),[g,F]=s.useState("all"),[$,S]=s.useState({}),{user:O}=J(),U=s.useMemo(()=>K({title:X().min(1,"제목을 입력하세요"),is_published:W()}),[]),{register:C,handleSubmit:z,reset:h,formState:{errors:E,isSubmitting:P}}=Z({resolver:ee(U),defaultValues:{title:"",is_published:!1}}),m=async()=>{try{f(!0);const{data:t,error:r}=await i.from("partner_pages").select("id, title, is_published, created_at, created_by").order("created_at",{ascending:!1});if(r)throw r;M(t??[]);const a=(t??[]).map(u=>u.id);if(a.length>0){const{data:u}=await i.from("partner_page_assignments").select("page_id, user_id").in("page_id",a),b={};for(const q of u??[]){const L=q.page_id,G=q.user_id;b[L]||(b[L]=G)}S(b)}else S({})}catch(t){d(t.message||"로딩 실패")}finally{f(!1)}};s.useEffect(()=>{m()},[]);const I=s.useMemo(()=>y.filter(t=>{const r=n.trim()===""||t.title.toLowerCase().includes(n.toLowerCase())||t.id.includes(n),a=g==="all"?!0:g==="pub"?t.is_published:!t.is_published;return r&&a}),[y,n,g]),H=()=>{k(null),h({title:"",is_published:!1}),x(""),o(!0),p("")},Q=async t=>{try{d(""),p("");const{data:r,error:a}=await i.from("partner_pages").select("id, title, excerpt, is_published, content").eq("id",t).maybeSingle();if(a)throw a;if(!r)return;k(t),h({title:r.title,is_published:!!r.is_published}),x(r.content||""),o(!0)}catch(r){d(r.message||"불러오기 실패")}},V=async t=>{try{if(!l||l.trim().length===0)throw new Error("콘텐츠(본문)를 입력하세요");if(d(""),c){const{error:r}=await i.from("partner_pages").update({title:t.title,is_published:t.is_published,content:l}).eq("id",c);if(r)throw r}else{const{error:r}=await i.from("partner_pages").insert({title:t.title,is_published:t.is_published,content:l});if(r)throw r}o(!1),x(""),h({title:"",is_published:!1}),N(c?"페이지가 수정되었습니다.":"새 페이지가 생성되었습니다."),setTimeout(()=>N(""),3e3),await m()}catch(r){const a=r?.message||"저장 실패";p(a)}},Y=async t=>{if(confirm("정말 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다."))try{const{error:r}=await i.from("partner_pages").delete().eq("id",t);if(r)throw r;await m()}catch(r){d(r.message||"삭제 실패")}},B=async(t,r)=>{try{const{error:a}=await i.from("partner_pages").update({is_published:r}).eq("id",t);if(a)throw a;await m()}catch(a){d(a.message||"상태 변경 실패")}};return e.jsx(te,{children:e.jsxs("div",{className:"p-4 sm:p-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-4",children:"파트너 페이지"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between mb-4",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",placeholder:"제목/ID 검색",value:n,onChange:t=>T(t.target.value),className:"w-64 rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm"}),e.jsxs("select",{value:g,onChange:t=>F(t.target.value),className:"rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm",children:[e.jsx("option",{value:"all",children:"전체"}),e.jsx("option",{value:"pub",children:"발행"}),e.jsx("option",{value:"draft",children:"임시"})]})]}),e.jsxs("div",{className:"text-gray-700 dark:text-gray-300",children:["총 ",I.length,"개"]}),e.jsx("button",{onClick:H,className:"px-3 py-2 rounded-md bg-blue-600 text-white text-sm hover:bg-blue-700",children:"새 페이지"})]}),w&&e.jsx("div",{className:"mb-3 px-4 py-3 rounded bg-green-50 text-green-700 dark:bg-green-900/20 dark:text-green-300 border border-green-200 dark:border-green-800",children:w}),D?e.jsx("div",{className:"text-gray-700 dark:text-gray-300",children:"로딩 중..."}):j?e.jsx("div",{className:"text-red-600 dark:text-red-400",children:j}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-800",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider",children:"ID"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider",children:"Title"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider",children:"Published"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider",children:"Created"}),e.jsx("th",{className:"px-4 py-2"})]})}),e.jsx("tbody",{className:"bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-800",children:I.map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-2 text-sm text-gray-900 dark:text-gray-100",children:t.id}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-700 dark:text-gray-300",children:t.title}),e.jsx("td",{className:"px-4 py-2 text-sm",children:e.jsx("span",{className:`px-2 py-1 rounded text-xs ${t.is_published?"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300":"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300"}`,children:t.is_published?"Yes":"No"})}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-700 dark:text-gray-300",children:new Date(t.created_at).toLocaleString()}),e.jsxs("td",{className:"px-4 py-2 text-sm text-right space-x-2",children:[(()=>{const r=t.created_by||$[t.id]||O?.id;return r?e.jsx("a",{href:`/partner/pages/${r}/${t.id}`,target:"_blank",rel:"noreferrer",className:"px-2 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 text-gray-800 dark:text-gray-200",children:"보기"}):null})(),e.jsx("button",{onClick:()=>B(t.id,!t.is_published),className:"px-2 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 text-gray-800 dark:text-gray-200",children:t.is_published?"Unpublish":"Publish"}),e.jsx("button",{onClick:()=>Q(t.id),className:"px-2 py-1 text-xs rounded bg-blue-600 hover:bg-blue-700 text-white",children:"Edit"}),e.jsx("button",{onClick:()=>Y(t.id),className:"px-2 py-1 text-xs rounded bg-red-600 hover:bg-red-700 text-white",children:"Delete"})]})]},t.id))})]})}),R&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"bg-white dark:bg-gray-900 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-auto",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 dark:border-gray-800 flex items-center justify-between",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:c?"파트너 페이지 수정":"새 파트너 페이지"}),e.jsx("button",{onClick:()=>o(!1),className:"text-gray-600 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white",children:"닫기"})]}),e.jsxs("form",{onSubmit:z(V),className:"p-4 space-y-4",children:[v&&e.jsx("div",{className:"px-4 py-3 rounded bg-red-50 text-red-700 dark:bg-red-900/20 dark:text-red-300 border border-red-200 dark:border-red-800",children:v}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"제목"}),e.jsx("input",{type:"text",className:"mt-1 w-full rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm",...C("title")}),E.title&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:E.title.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"본문"}),e.jsx(re,{value:l,onChange:x,height:400})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{id:"is_published",type:"checkbox",...C("is_published")}),e.jsx("span",{className:"text-sm text-gray-800 dark:text-gray-200",children:"발행"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:_,onChange:t=>A(t.target.checked)}),e.jsx("span",{className:"text-sm text-gray-800 dark:text-gray-200",children:"미리보기"})]})]}),_&&e.jsxs("div",{className:"border border-gray-200 dark:border-gray-800 rounded p-3",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2",children:"미리보기"}),e.jsx("article",{className:"prose dark:prose-invert max-w-none",dangerouslySetInnerHTML:{__html:l}})]}),e.jsx("div",{className:"pt-2",children:e.jsx("button",{type:"submit",disabled:P,className:"px-4 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-50",children:P?"저장 중...":"저장"})})]})]})})]})})};export{ne as default};
