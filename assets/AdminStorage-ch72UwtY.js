import{j as t,a1 as ze,p as $e,V as Ue,a2 as _e,o as Be,t as Fe,a3 as Re,R as Ie}from"./ui-BLaX9ps4.js";import{r as n}from"./router-CLvrYEWH.js";import{B as Me}from"./Breadcrumb-DLoGhAph.js";import{s as v}from"./index-DjrO50vo.js";import{listFiles as Pe,isImage as C,getPublicUrl as F,createSignedUrl as Te,uploadFile as De,sanitizePrefix as te,moveFile as ae,copyFile as Le,removeFile as Ae,sanitizeFileName as Ee}from"./storage-CpyyIYHs.js";import"./vendor-RGnvvjkK.js";const A=["blog-images","project-images"],qe=["blog-images","project-images"],et=()=>{const[E,Ke]=n.useState([...A]),[d,se]=n.useState(A[0]),[m,re]=n.useState(""),[N,q]=n.useState([]),[ne,K]=n.useState(0),[ie,le]=n.useState(!1),[R,W]=n.useState(!1),[X,G]=n.useState(!1),[S,c]=n.useState(""),[I,x]=n.useState(""),[M,oe]=n.useState(""),[o,h]=n.useState(new Set),z=n.useRef(null),[ce,We]=n.useState(300),[$,de]=n.useState("all"),[P,xe]=n.useState(A[0]),[T,me]=n.useState(""),[H,O]=n.useState(!1),[V,Z]=n.useState(!1),[Xe,J]=n.useState(!1),[Ge,He]=n.useState(-1),[Q,Y]=n.useState({}),[U,ge]=n.useState({}),[j,_]=n.useState("created"),[k,B]=n.useState("desc"),D=50,pe=qe.includes(d),ue=()=>{p.length!==0&&(o.size===p.length?h(new Set):h(new Set(p.map(e=>e.name))))},L=n.useMemo(()=>{const e=N.filter(s=>s?.metadata==null).map(s=>s.name.replace(/\/$/,""));return Array.from(new Set(e)).sort((s,a)=>s.localeCompare(a))},[N]),ye=n.useMemo(()=>{const e=(m||"").replace(/\/$/,""),s=L.map(a=>e?`${e}/${a}`:a);return Array.from(new Set(s))},[L,m]);n.useEffect(()=>{y(!0)},[d,m]);const y=async(e=!1)=>{try{W(!0),c("");const s=e?0:ne,a=await Pe(d,{prefix:m,limit:D,offset:s*D,sortBy:{column:"name",order:"desc"}});q(r=>e?a:[...r,...a]),le((a?.length||0)===D),K(e?1:s+1)}catch(s){c(s.message||"파일을 불러오지 못했습니다.")}finally{W(!1)}},he=e=>{if(!e&&e!==0)return"—";const s=["B","KB","MB","GB"];let a=0,r=e;for(;r>=1024&&a<s.length-1;)r/=1024,a++;return`${r.toFixed(a===0?0:1)} ${s[a]}`},be=(e,s)=>{if(Q[e])return;const a=new Image;a.onload=()=>{Y(r=>({...r,[e]:{w:a.naturalWidth,h:a.naturalHeight}}))},a.onerror=()=>{Y(r=>({...r,[e]:{w:0,h:0}}))},a.src=s},fe=async e=>{try{const{count:s}=await v.from("blog_posts").select("id",{count:"exact",head:!0}).eq("image_url",e),{count:a}=await v.from("blog_posts").select("id",{count:"exact",head:!0}).ilike("content",`%${e}%`);return(s||0)+(a||0)}catch{return 0}},je=async e=>{if(e.size>10485760){c("파일 크기는 10MB 이하여야 합니다.");return}if(!["image/","text/plain","application/pdf","application/json","application/zip","application/x-zip-compressed"].some(r=>e.type.startsWith(r))){c("허용되지 않는 파일 형식입니다.");return}if(e)try{G(!0),c(""),await De(d,e,m),await y(!0)}catch(r){c(r.message||"업로드에 실패했습니다.")}finally{G(!1)}},ke=e=>{h(s=>{const a=new Set(s);return a.has(e)?a.delete(e):a.add(e),a})},we=async()=>{if(o.size!==0&&confirm(`선택한 ${o.size}개 파일을 삭제하시겠습니까?`))try{c("");for(const e of o)await Ae(d,e);h(new Set),await y(!0)}catch(e){c(e.message||"삭제에 실패했습니다.")}},ee=()=>h(new Set),ve=async()=>{if(o.size===0)return;if(P!==d){c("서로 다른 버킷 간 이동은 현재 UI에서 지원되지 않습니다. 동일 버킷 내에서 이동해 주세요.");return}const e=te(T);try{O(!0),c(""),x("파일 이동 중...");let s=0;for(const a of o){const r=a.split("/").pop()||a,i=e?`${e}/${r}`:r;if(i===a){s++;continue}await ae(d,a,i),s++,x(`${s}/${o.size} 이동 완료`)}x("이동 완료"),ee(),await y(!0)}catch(s){c(s.message||"이동에 실패했습니다.")}finally{O(!1),setTimeout(()=>x(""),1500)}},Ne=async()=>{if(o.size===0)return;if(P!==d){c("서로 다른 버킷 간 복사는 현재 UI에서 지원되지 않습니다. 동일 버킷 내에서 복사해 주세요.");return}const e=te(T);try{Z(!0),c(""),x("파일 복사 중...");let s=0;for(const a of o){const r=a.split("/").pop()||a,i=e?`${e}/${r}`:r;await Le(d,a,i),s++,x(`${s}/${o.size} 복사 완료`)}x("복사 완료"),ee(),await y(!0)}catch(s){c(s.message||"복사에 실패했습니다.")}finally{Z(!1),setTimeout(()=>x(""),1500)}},Se=async e=>{const s=e.split("/").pop()||e,a=prompt("새 파일명을 입력하세요(확장자 포함):",s);if(!a)return;const r=Ee(a),i=e.includes("/")?e.slice(0,e.lastIndexOf("/")):"",g=i?`${i}/${r}`:r;if(g!==e)try{J(!0),c(""),x("이름 변경 중...");const w=F(d,e);await ae(d,e,g);const l=F(d,g);x("이름 변경 완료 - 참조 업데이트 중..."),await Ce(w,l),x("이름 변경 및 참조 업데이트 완료"),await y(!0)}catch(w){c(w.message||"이름 변경에 실패했습니다.")}finally{J(!1),setTimeout(()=>x(""),1500)}},Ce=async(e,s)=>{try{await v.from("blog_posts").update({image_url:s}).eq("image_url",e),await v.from("projects").update({image_url:s}).eq("image_url",e);const{data:a}=await v.from("blog_posts").select("id, content").ilike("content",`%${e}%`);if(a&&a.length>0){let r=0;for(const i of a){const g=(i.content||"").split(e).join(s);g!==i.content&&(await v.from("blog_posts").update({content:g}).eq("id",i.id),r++,x(`본문 참조 업데이트 중... ${r}/${a.length}`))}}}catch(a){c("참조 업데이트 중 일부 실패가 발생했습니다. 상세 로그는 콘솔을 참고하세요."),console.error("updateReferences failed:",a)}},p=n.useMemo(()=>{const e=M.trim().toLowerCase();let s=N.filter(l=>{const b=l.metadata?.size,u=(l.name.split("/").pop()||l.name).toLowerCase(),f=u.startsWith(".")||u.includes("emptyfolderplaceholder");return b!=null&&b>0&&!f});e&&(s=s.filter(l=>l.name.toLowerCase().includes(e))),$==="image"&&(s=s.filter(l=>C(l.name))),$==="other"&&(s=s.filter(l=>!C(l.name)));const a=j,r=k==="asc"?1:-1,i=l=>l.metadata?.size??-1,g=l=>l.created_at?new Date(l.created_at).getTime():0,w=l=>U[l.name]??-1;return s=[...s].sort((l,b)=>{let u=0,f=0;return a==="name"?(u=l.name.localeCompare(b.name),f=0):a==="size"?(u=i(l),f=i(b)):a==="usage"?(u=w(l),f=w(b)):(u=g(l),f=g(b)),a==="name"?u*r:(u-f)*r}),s},[N,M,$,j,k,U]);return n.useEffect(()=>{p.forEach(e=>{const s=e.publicUrl||F(d,e.name);C(e.name)&&be(e.name,s),U[e.name]==null&&fe(s).then(a=>{ge(r=>({...r,[e.name]:a}))})})},[p]),t.jsxs("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900",children:[t.jsx("header",{className:"bg-white dark:bg-gray-800 shadow-sm",children:t.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:[t.jsx("div",{children:t.jsx(Me,{items:[{label:"스토리지 관리",path:"/admin/storage"}]})}),t.jsxs("div",{className:"flex flex-col gap-4 pb-6",children:[t.jsx("div",{className:"flex items-center justify-between",children:t.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"스토리지 관리"})}),t.jsxs("div",{className:"flex flex-col gap-3",children:[t.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("select",{value:d,onChange:e=>{se(e.target.value),K(0),q([]),h(new Set)},className:"px-3 py-2 rounded-md border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white",children:E.map(e=>t.jsx("option",{value:e,children:e},e))}),t.jsxs("select",{value:m,onChange:e=>re(e.target.value),className:"px-3 py-2 rounded-md border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white w-56","aria-label":"폴더 선택",children:[t.jsx("option",{value:"",children:"/ (루트)"}),m&&t.jsx("option",{value:m,children:`${m.replace(/\/+$/,"")}/ (현재)`}),L.map(e=>t.jsxs("option",{value:e+"/",children:[e,"/"]},e))]}),t.jsxs("button",{type:"button",onClick:()=>y(!0),className:"inline-flex items-center gap-1 px-3 py-2 rounded-md border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700",children:[t.jsx(ze,{size:16})," 새로고침"]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("div",{className:"relative",children:[t.jsx($e,{size:16,className:"absolute left-2 top-1/2 -translate-y-1/2 text-gray-400"}),t.jsx("input",{value:M,onChange:e=>oe(e.target.value),placeholder:"파일명 검색",className:"pl-8 pr-3 py-2 rounded-md border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white w-60","aria-label":"파일명 검색"})]}),t.jsxs("select",{value:$,onChange:e=>de(e.target.value),className:"px-3 py-2 rounded-md border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white","aria-label":"유형 필터",children:[t.jsx("option",{value:"all",children:"전체"}),t.jsx("option",{value:"image",children:"이미지"}),t.jsx("option",{value:"other",children:"기타"})]})]})]}),t.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("input",{ref:z,type:"file",multiple:!0,onChange:async e=>{const s=Array.from(e.target.files||[]);for(const a of s)await je(a);z.current&&(z.current.value="")},className:"hidden",accept:"*/*"}),t.jsxs("button",{type:"button",onClick:()=>z.current?.click(),disabled:X,className:"inline-flex items-center gap-2 bg-blue-600 text-white px-3 py-2 rounded-md hover:bg-blue-700 disabled:opacity-50","aria-label":"파일 업로드",children:[t.jsx(Ue,{size:16})," ",X?"업로드 중...":"새 이미지"]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-300 hidden md:inline",children:"선택 항목 관리"}),t.jsx("select",{value:P,onChange:e=>xe(e.target.value),disabled:o.size===0,className:"px-3 py-2 rounded-md border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white disabled:opacity-50 disabled:cursor-not-allowed","aria-label":"대상 버킷",title:o.size===0?"항목을 선택하면 활성화됩니다":void 0,children:E.map(e=>t.jsx("option",{value:e,children:e},e))}),t.jsxs("select",{value:T,onChange:e=>me(e.target.value),disabled:o.size===0,className:"px-3 py-2 rounded-md border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white w-56 disabled:opacity-50 disabled:cursor-not-allowed","aria-label":"대상 프리픽스",title:o.size===0?"항목을 선택하면 활성화됩니다":void 0,children:[t.jsx("option",{value:"",children:"/ (루트)"}),m&&t.jsx("option",{value:m,children:`${m.replace(/\/+$/,"")}/ (현재)`}),ye.map(e=>t.jsxs("option",{value:e+"/",children:[e,"/"]},e))]}),t.jsxs("button",{type:"button",onClick:ve,disabled:o.size===0||H,className:"inline-flex items-center gap-2 bg-amber-600 text-white px-3 py-2 rounded-md hover:bg-amber-700 disabled:opacity-50","aria-label":"이동",children:[t.jsx(_e,{size:16})," ",H?"이동 중...":"이동"]}),t.jsxs("button",{type:"button",onClick:Ne,disabled:o.size===0||V,className:"inline-flex items-center gap-2 bg-emerald-600 text-white px-3 py-2 rounded-md hover:bg-emerald-700 disabled:opacity-50","aria-label":"복사",children:[t.jsx(Be,{size:16})," ",V?"복사 중...":"복사"]}),t.jsxs("button",{type:"button",onClick:we,disabled:o.size===0,className:"inline-flex items-center gap-2 bg-red-600 text-white px-3 py-2 rounded-md hover:bg-red-700 disabled:opacity-50","aria-label":"삭제",children:[t.jsx(Fe,{size:16})," 삭제"]}),t.jsxs("button",{type:"button",onClick:()=>h(new Set),disabled:o.size===0,className:"inline-flex items-center gap-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 px-3 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 disabled:opacity-50","aria-label":"선택 해제",children:[t.jsx(Re,{size:16})," 선택 해제"]})]})]})]})]})]})}),t.jsxs("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[S&&t.jsx("div",{className:"mb-6 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-600 dark:text-red-400 px-4 py-3 rounded-md",children:S}),(S||I)&&t.jsxs("div",{"aria-live":"polite",className:"mb-4 space-y-2",children:[S&&t.jsx("div",{className:"bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-600 dark:text-red-400 px-4 py-3 rounded-md",children:S}),I&&t.jsx("div",{className:"bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 text-green-700 dark:text-green-300 px-4 py-3 rounded-md",children:I})]}),t.jsx("div",{className:"min-h-[200px]",children:R&&N.length===0?t.jsx("div",{className:"flex items-center justify-center py-12 text-gray-500 dark:text-gray-400",children:"불러오는 중..."}):p.length===0?t.jsx("div",{className:"text-center py-12 text-gray-500 dark:text-gray-400",children:"파일이 없습니다."}):t.jsx("div",{className:"overflow-auto rounded-md border border-gray-200 dark:border-gray-700",children:t.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700 table-fixed",children:[t.jsx("thead",{className:"bg-gray-50 dark:bg-gray-800",children:t.jsxs("tr",{children:[t.jsx("th",{className:"w-12 px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300",children:t.jsx("input",{type:"checkbox","aria-label":"전체 선택",checked:p.length>0&&o.size===p.length,onChange:ue,className:"h-4 w-4"})}),t.jsx("th",{className:"w-28 px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300",children:"미리보기"}),t.jsxs("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 cursor-pointer select-none",onClick:()=>{_("name"),B(e=>e==="asc"?"desc":"asc")},children:["파일명 ",j==="name"?k==="asc"?"▲":"▼":""]}),t.jsx("th",{className:"w-28 px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300",children:"이미지 크기"}),t.jsxs("th",{className:"w-24 px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 cursor-pointer select-none",onClick:()=>{_("size"),B(e=>e==="asc"?"desc":"asc")},children:["파일 크기 ",j==="size"?k==="asc"?"▲":"▼":""]}),t.jsxs("th",{className:"w-40 px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 cursor-pointer select-none",onClick:()=>{_("created"),B(e=>e==="asc"?"desc":"asc")},children:["업로드일자 ",j==="created"?k==="asc"?"▲":"▼":""]}),t.jsxs("th",{className:"w-28 px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 cursor-pointer select-none",onClick:()=>{_("usage"),B(e=>e==="asc"?"desc":"asc")},children:["사용 ",j==="usage"?k==="asc"?"▲":"▼":""]}),t.jsx("th",{className:"w-32 px-3 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-300",children:"액션"})]})}),t.jsx("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700 bg-white dark:bg-gray-900",children:p.map(e=>{const s=e.publicUrl||F(d,e.name),a=Q[e.name],r=U[e.name];return t.jsxs("tr",{className:o.has(e.name)?"bg-blue-50 dark:bg-blue-900/20":"",children:[t.jsx("td",{className:"px-3 py-2 align-middle",children:t.jsx("input",{type:"checkbox",checked:o.has(e.name),onChange:i=>{i.stopPropagation(),ke(e.name)},"aria-label":"선택",className:"h-4 w-4"})}),t.jsx("td",{className:"px-3 py-2",children:C(e.name)?t.jsx("img",{src:s,alt:e.name,className:"w-20 h-20 object-cover rounded",loading:"lazy"}):t.jsx("div",{className:"w-20 h-20 rounded bg-gray-100 dark:bg-gray-800 flex items-center justify-center",children:t.jsx(Ie,{size:20,className:"text-gray-500"})})}),t.jsx("td",{className:"px-3 py-2",children:t.jsx("div",{className:"text-sm text-gray-900 dark:text-gray-100 break-all",children:e.name})}),t.jsx("td",{className:"px-3 py-2 text-sm text-gray-700 dark:text-gray-300",children:C(e.name)?a?`${a.w}×${a.h}`:"측정 중...":"—"}),t.jsx("td",{className:"px-3 py-2 text-sm text-gray-700 dark:text-gray-300",children:he(e.metadata?.size)}),t.jsx("td",{className:"px-3 py-2 text-sm text-gray-700 dark:text-gray-300",children:e.created_at?new Date(e.created_at).toLocaleString():"—"}),t.jsx("td",{className:"px-3 py-2 text-sm text-gray-700 dark:text-gray-300",children:r??"집계 중..."}),t.jsx("td",{className:"px-3 py-2",children:t.jsxs("div",{className:"flex flex-col items-stretch gap-2 w-32",children:[t.jsx("a",{href:s,target:"_blank",rel:"noopener noreferrer",className:"w-full text-center px-2 py-1 text-xs rounded bg-teal-500 hover:bg-indigo-900 text-white",onClick:i=>i.stopPropagation(),children:"보기"}),t.jsx("button",{type:"button",className:"w-full text-center px-2 py-1 text-xs rounded bg-teal-600 hover:bg-indigo-900 text-white",onClick:i=>{i.stopPropagation(),Se(e.name)},title:"이름 변경",children:"이름변경"}),t.jsx("button",{type:"button",className:"w-full text-center px-2 py-1 text-xs rounded bg-teal-700 hover:bg-indigo-900 text-white",onClick:i=>{i.stopPropagation(),navigator.clipboard.writeText(s)},title:"URL 복사",children:"URL 복사"}),!pe&&t.jsx("button",{type:"button",className:"w-full text-center px-2 py-1 text-xs rounded bg-teal-800 hover:bg-indigo-900 text-white",onClick:async i=>{i.stopPropagation();const g=await Te(d,e.name,ce);await navigator.clipboard.writeText(g)},title:"서명 URL 복사",children:"서명 URL"})]})})]},e.name)})})]})})}),ie&&t.jsx("div",{className:"flex justify-center pt-4",children:t.jsx("button",{type:"button",disabled:R,onClick:()=>y(!1),className:"px-4 py-2 text-sm rounded-md border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50",children:R?"불러오는 중...":"더 보기"})})]})]})};export{et as default};
