import{j as e,X as $,a0 as B,o as K}from"./ui-BzsjKXiP.js";import{r}from"./router-CLvrYEWH.js";import{listFiles as T,isImage as E,getPublicUrl as A}from"./storage-DrRvxGB9.js";const z=50,H=({isOpen:l,onClose:p,onSelect:u,bucket:c})=>{const[d,n]=r.useState([]),[f,b]=r.useState(0),[v,o]=r.useState(!1),[y,L]=r.useState(!1),[U,k]=r.useState(""),[N,M]=r.useState(""),[x,_]=r.useState(""),[m,w]=r.useState("created"),[h,C]=r.useState("desc");r.useEffect(()=>{l&&(n([]),b(0),o(!1),k(""),S(!0))},[l,c,x]);const S=async(t=!1)=>{try{L(!0),k("");const s=t?0:f,i=await T(c,{prefix:x,limit:z,offset:s*z,sortBy:{column:"name",order:"desc"}});n(j=>t?i:[...j,...i]),o((i?.length||0)===z),b(t?1:s+1)}catch(s){k(s.message||"이미지 목록을 불러오지 못했습니다.")}finally{L(!1)}},D=r.useMemo(()=>Array.from(new Set(d.filter(t=>t?.metadata==null).map(t=>t.name.replace(/\/$/,"")))).sort((t,s)=>t.localeCompare(s)),[d]),I=r.useMemo(()=>{let t=d.filter(a=>{const g=a.metadata?.size,R=(a.name.split("/").pop()||a.name).toLowerCase().startsWith(".");return g!=null&&g>0&&!R&&E(a.name)});const s=N.trim().toLowerCase();s&&(t=t.filter(a=>a.name.toLowerCase().includes(s)));const i=h==="asc"?1:-1,j=a=>a.metadata?.size??-1,P=a=>a.created_at?new Date(a.created_at).getTime():0;return t=[...t].sort((a,g)=>m==="name"?a.name.localeCompare(g.name)*i:m==="size"?(j(a)-j(g))*i:(P(a)-P(g))*i),t},[d,N,m,h]);return l?e.jsxs("div",{className:"fixed inset-0 z-[100000]",children:[" ",e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:p}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-5xl bg-white dark:bg-gray-800 rounded-lg shadow-xl overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-gray-200 dark:border-gray-700",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-white",children:["라이브러리에서 선택 (",c,")"]})}),e.jsx("button",{onClick:p,className:"p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700",children:e.jsx($,{size:18})})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{value:x,onChange:t=>_(t.target.value),className:"px-3 py-2 rounded-md border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white w-56","aria-label":"폴더 선택",children:[e.jsx("option",{value:"",children:"/ (루트)"}),x&&e.jsx("option",{value:x,children:`${x.replace(/\/+$/,"")}/ (현재)`}),D.map(t=>e.jsxs("option",{value:t+"/",children:[t,"/"]},t))]}),e.jsxs("button",{type:"button",onClick:()=>S(!0),className:"inline-flex items-center gap-1 px-3 py-2 rounded-md border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700",children:[e.jsx(B,{size:16})," 새로고침"]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(K,{size:16,className:"absolute left-2 top-1/2 -translate-y-1/2 text-gray-400"}),e.jsx("input",{value:N,onChange:t=>M(t.target.value),placeholder:"파일명 검색",className:"pl-8 pr-3 py-2 rounded-md border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white w-64"})]})]}),e.jsx("div",{className:"min-h-[240px]",children:y&&d.length===0?e.jsx("div",{className:"flex items-center justify-center py-12 text-gray-500 dark:text-gray-400",children:"불러오는 중..."}):I.length===0?e.jsx("div",{className:"text-center py-12 text-gray-500 dark:text-gray-400",children:"파일이 없습니다."}):e.jsx("div",{className:"overflow-auto rounded-md border border-gray-200 dark:border-gray-700",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700 table-fixed",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-800",children:e.jsxs("tr",{children:[e.jsx("th",{className:"w-28 px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300",children:"미리보기"}),e.jsxs("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 cursor-pointer select-none",onClick:()=>{w("name"),C(t=>t==="asc"?"desc":"asc")},children:["파일명 ",m==="name"?h==="asc"?"▲":"▼":""]}),e.jsxs("th",{className:"w-24 px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 cursor-pointer select-none",onClick:()=>{w("size"),C(t=>t==="asc"?"desc":"asc")},children:["크기 ",m==="size"?h==="asc"?"▲":"▼":""]}),e.jsxs("th",{className:"w-40 px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 cursor-pointer select-none",onClick:()=>{w("created"),C(t=>t==="asc"?"desc":"asc")},children:["업로드일자 ",m==="created"?h==="asc"?"▲":"▼":""]}),e.jsx("th",{className:"w-28 px-3 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-300",children:"선택"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700 bg-white dark:bg-gray-900",children:I.map(t=>{const s=t.publicUrl||A(c,t.name);return e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2",children:E(t.name)?e.jsx("img",{src:s,alt:t.name,className:"w-20 h-20 object-cover rounded",loading:"lazy"}):e.jsx("div",{className:"w-20 h-20 rounded bg-gray-100 dark:bg-gray-800"})}),e.jsx("td",{className:"px-3 py-2",children:e.jsx("div",{className:"text-sm text-gray-900 dark:text-gray-100 break-all",children:t.name})}),e.jsx("td",{className:"px-3 py-2 text-sm text-gray-700 dark:text-gray-300",children:(t.metadata?.size??0)>0?`${(t.metadata.size/1024).toFixed(1)} KB`:"—"}),e.jsx("td",{className:"px-3 py-2 text-sm text-gray-700 dark:text-gray-300",children:t.created_at?new Date(t.created_at).toLocaleString():"—"}),e.jsx("td",{className:"px-3 py-2",children:e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{type:"button",className:"px-3 py-1 text-xs rounded bg-teal-600 hover:bg-indigo-900 text-white",onClick:()=>u(s),children:"선택"})})})]},t.name)})})]})})}),v&&e.jsx("div",{className:"flex justify-center pt-2",children:e.jsx("button",{type:"button",disabled:y,onClick:()=>S(!1),className:"px-4 py-2 text-sm rounded-md border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50",children:y?"불러오는 중...":"더 보기"})})]})]})})]}):null},F=r.createContext(void 0),Z=({children:l})=>{const[p,u]=r.useState(!1),[c,d]=r.useState("blog-images"),n=r.useRef(null),f=r.useCallback(({bucket:o})=>(d(o),u(!0),new Promise(y=>{n.current=y})),[]),b=()=>{n.current&&n.current(null),n.current=null,u(!1)},v=o=>{n.current&&n.current(o),n.current=null,u(!1)};return e.jsxs(F.Provider,{value:{open:f},children:[l,e.jsx("div",{id:"image-library-portal",className:"fixed inset-0 pointer-events-none z-[100000]",children:e.jsx("div",{className:"pointer-events-auto",children:e.jsx(H,{isOpen:p,onClose:b,onSelect:v,bucket:c})})})]})},J=()=>{const l=r.useContext(F);if(!l)throw new Error("useImageLibrary must be used within ImageLibraryProvider");return l};export{Z as I,J as u};
